<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>A-Frame VR Physics</title>

  <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/aframe-physics-system@4.0.1/dist/aframe-physics-system.min.js"></script>

  <script>
    /* =========================
       JOYSTICK PHYSICS MOVEMENT
    ==========================*/
    AFRAME.registerComponent("joystick-move", {
      schema: {
        speed: { default: 4 },
        jumpForce: { default: 6 }
      },

      init() {
        this.body = this.el.components["dynamic-body"].body;
        this.dir = new THREE.Vector3();
        this.right = new THREE.Vector3();
        this.canJump = false;

        // Jump (A button)
        this.el.sceneEl.addEventListener("abuttondown", () => {
          if (this.canJump) {
            this.body.velocity.y = this.data.jumpForce;
            this.canJump = false;
          }
        });

        // Ground detection
        this.el.addEventListener("collisions", e => {
          this.canJump = true;
        });

        // Left hand reference
        this.leftHand = document.querySelector("#leftHand");
      },

      tick() {
        if (!this.body || !this.leftHand) return;

        const controller = this.leftHand.components["tracked-controls"];
        if (!controller || !controller.controller) return;

        const axes = controller.controller.axes;
        const x = axes[2] || 0;
        const z = axes[3] || 0;

        if (Math.abs(x) < 0.1 && Math.abs(z) < 0.1) return;

        const cam = this.el.querySelector("[camera]");
        cam.object3D.getWorldDirection(this.dir);
        this.dir.y = 0;
        this.dir.normalize();

        this.right.crossVectors(this.dir, new THREE.Vector3(0, 1, 0));

        this.body.velocity.x =
          (this.dir.x * -z + this.right.x * x) * this.data.speed;
        this.body.velocity.z =
          (this.dir.z * -z + this.right.z * x) * this.data.speed;
      }
    });

    /* =========================
       GRAB & THROW
    ==========================*/
    AFRAME.registerComponent("grabber", {
      init() {
        this.grabbed = null;

        this.el.addEventListener("gripdown", () => {
          const hit = this.el.components.raycaster?.intersectedEls[0];
          if (!hit || !hit.components["dynamic-body"]) return;

          this.grabbed = hit;
          hit.body.sleep();
          hit.setAttribute("constraint", {
            type: "lock",
            target: `#${this.el.id}`
          });
        });

        this.el.addEventListener("gripup", () => {
          if (!this.grabbed) return;

          this.grabbed.removeAttribute("constraint");
          this.grabbed.body.wakeUp();
          this.grabbed = null;
        });
      }
    });
  </script>
</head>

<body>
<a-scene physics="driver: cannon; gravity: -9.8">

  <!-- PLAYER (PHYSICS ROOT) -->
  <a-entity
    id="player"
    position="0 1.6 0"
    dynamic-body="shape: capsule; radius: 0.25; height: 1.6"
    joystick-move
  >

    <!-- CAMERA -->
    <a-camera></a-camera>

    <!-- HANDS (CHILD OF PLAYER) -->
    <a-entity
      id="leftHand"
      hand-controls="hand: left"
      raycaster="objects: .grabbable"
      grabber
    ></a-entity>

    <a-entity
      id="rightHand"
      hand-controls="hand: right"
      raycaster="objects: .grabbable"
      grabber
    ></a-entity>

  </a-entity>

  <!-- FLOOR -->
  <a-box
    static-body
    position="0 -0.5 0"
    scale="20 1 20"
    color="#7BC8A4"
  ></a-box>

  <!-- PLATFORM -->
  <a-box
    static-body
    position="0 1 -3"
    scale="2 0.5 2"
    color="#FFC65D"
  ></a-box>

  <!-- OBJECTS -->
  <a-sphere
    class="grabbable"
    dynamic-body
    position="1 2 -2"
    radius="0.2"
    color="#EF2D5E"
  ></a-sphere>

  <a-box
    class="grabbable"
    dynamic-body
    position="-1 2 -2"
    scale="0.3 0.3 0.3"
    color="#4CC3D9"
  ></a-box>

  <a-light type="ambient" intensity="0.5"></a-light>
  <a-light type="directional" position="1 3 2"></a-light>

</a-scene>
</body>
</html>
